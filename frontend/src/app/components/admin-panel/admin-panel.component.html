<div class="admin-panel">
  <div class="admin-header">
    <h1>üëë Admin-Panel</h1>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button
      class="tab"
      [class.active]="activeTab() === 'welcome'"
      (click)="setActiveTab('welcome')">
      üì¢ Willkommensnachricht
    </button>
    <button
      class="tab"
      [class.active]="activeTab() === 'broadcast'"
      (click)="setActiveTab('broadcast')">
      üì£ Broadcast-Posts
    </button>
    <button
      class="tab"
      [class.active]="activeTab() === 'status'"
      (click)="setActiveTab('status')">
      üìä System-Status
    </button>
    <button
      class="tab"
      [class.active]="activeTab() === 'settings'"
      (click)="setActiveTab('settings')">
      ‚öôÔ∏è Einstellungen
    </button>
    <button
      class="tab"
      [class.active]="activeTab() === 'email-templates'"
      (click)="setActiveTab('email-templates')">
      üìß E-Mail-Templates
    </button>
  </div>

  <!-- Messages -->
  @if (error()) {
    <div class="alert alert-error">{{ error() }}</div>
  }

  @if (success()) {
    <div class="alert alert-success">{{ success() }}</div>
  }

  <!-- Welcome Message Tab -->
  @if (activeTab() === 'welcome') {
    <div class="tab-content">
      <h2>Willkommensnachricht verwalten</h2>
      <p class="description">
        Die Willkommensnachricht wird jedem Benutzer beim ersten Login angezeigt.
      </p>

      @if (welcomeStats()) {
        <div class="stats-card">
          <h3>üìä Statistiken</h3>
          <div class="stats-grid">
            <div class="stat">
              <span class="stat-label">Gesamt-Benutzer:</span>
              <span class="stat-value">{{ welcomeStats()!.total_users }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Gesehen:</span>
              <span class="stat-value">{{ welcomeStats()!.seen_count }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Noch nicht gesehen:</span>
              <span class="stat-value">{{ welcomeStats()!.unseen_count }}</span>
            </div>
          </div>
        </div>
      }

      <div class="form-card">
        <div class="form-group">
          <label for="welcome-title">Titel</label>
          <input
            id="welcome-title"
            type="text"
            [(ngModel)]="welcomeForm.title"
            placeholder="z.B. Willkommen bei SafeSpace!"
            maxlength="100">
        </div>

        <div class="form-group">
          <label for="welcome-content">Nachricht</label>
          <textarea
            id="welcome-content"
            [(ngModel)]="welcomeForm.content"
            placeholder="Deine Willkommensnachricht..."
            rows="8"></textarea>
        </div>

        <div class="button-group">
          <button
            class="btn btn-primary"
            (click)="saveWelcomeMessage()"
            [disabled]="loading()">
            {{ loading() ? '‚è≥ Speichern...' : 'üíæ Speichern' }}
          </button>

          @if (welcomeMessage()) {
            <button
              class="btn btn-danger"
              (click)="deleteWelcomeMessage()"
              [disabled]="loading()">
              üóëÔ∏è L√∂schen
            </button>
          }
        </div>
      </div>
    </div>
  }

  <!-- Broadcast Posts Tab -->
  @if (activeTab() === 'broadcast') {
    <div class="tab-content">
      <h2>Broadcast-Post erstellen</h2>
      <p class="description">
        Broadcast-Posts werden automatisch an alle Benutzer in ihrem Feed angezeigt und
        in deren Sprache √ºbersetzt.
      </p>

      <div class="form-card">
        <div class="form-group">
          <label for="broadcast-content">Post-Inhalt</label>
          <textarea
            id="broadcast-content"
            [(ngModel)]="broadcastForm.content"
            placeholder="Deine Nachricht an alle Benutzer..."
            rows="5"></textarea>
        </div>

        <div class="form-group">
          <label for="broadcast-visibility">Sichtbarkeit</label>
          <select id="broadcast-visibility" [(ngModel)]="broadcastForm.visibility">
            <option value="public">√ñffentlich</option>
            <option value="friends">Nur Freunde</option>
          </select>
        </div>

        <button
          class="btn btn-primary"
          (click)="createBroadcastPost()"
          [disabled]="loading()">
          {{ loading() ? '‚è≥ Erstellen...' : 'üì£ Broadcast senden' }}
        </button>
      </div>

      <h3>Bestehende Broadcast-Posts</h3>
      <div class="posts-list">
        @if (broadcastPosts().length === 0) {
          <p class="empty-state">Keine Broadcast-Posts vorhanden</p>
        }

        @for (post of broadcastPosts(); track post.post_id) {
          <div class="broadcast-post-card">
            <div class="post-header">
              <span class="post-date">{{ post.created_at | date:'medium' }}</span>
              <button
                class="btn-delete"
                (click)="deleteBroadcastPost(post.post_id)">
                üóëÔ∏è
              </button>
            </div>
            <p class="post-content">{{ post.content }}</p>
            <div class="post-stats">
              <span>‚ù§Ô∏è {{ post.likes_count }}</span>
              <span>üí¨ {{ post.comments_count }}</span>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- System Status Tab -->
  @if (activeTab() === 'status') {
    <div class="tab-content">
      <div class="status-header">
        <h2>üìä System-Status</h2>
        <button class="btn-refresh" (click)="loadSystemStatus()">üîÑ Aktualisieren</button>
      </div>

      @if (systemStatus()) {
        <div class="status-container">
          <!-- Server Uptime -->
          <div class="status-section">
            <h3>‚è±Ô∏è Server</h3>
            <div class="stats-grid">
              <div class="stat">
                <span class="stat-label">Uptime:</span>
                <span class="stat-value">{{ systemStatus()!.system.uptime }}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Letzte Aktualisierung:</span>
                <span class="stat-value">{{ systemStatus()!.timestamp | date:'medium' }}</span>
              </div>
            </div>
          </div>

          <!-- System Performance -->
          <div class="status-section">
            <h3>üíª Performance</h3>
            <div class="stats-grid">
              <div class="stat">
                <span class="stat-label">CPU Auslastung:</span>
                <span class="stat-value" [class.warning]="systemStatus()!.system.cpu_percent > 80">
                  {{ systemStatus()!.system.cpu_percent }}%
                </span>
              </div>
              <div class="stat">
                <span class="stat-label">RAM Auslastung:</span>
                <span class="stat-value" [class.warning]="systemStatus()!.system.memory.percent > 85">
                  {{ systemStatus()!.system.memory.percent }}%
                </span>
              </div>
              <div class="stat">
                <span class="stat-label">RAM Genutzt:</span>
                <span class="stat-value">
                  {{ systemStatus()!.system.memory.used_gb }} GB / {{ systemStatus()!.system.memory.total_gb }} GB
                </span>
              </div>
              <div class="stat">
                <span class="stat-label">Disk Auslastung:</span>
                <span class="stat-value" [class.warning]="systemStatus()!.system.disk.percent > 85">
                  {{ systemStatus()!.system.disk.percent }}%
                </span>
              </div>
              <div class="stat">
                <span class="stat-label">Disk Genutzt:</span>
                <span class="stat-value">
                  {{ systemStatus()!.system.disk.used_gb }} GB / {{ systemStatus()!.system.disk.total_gb }} GB
                </span>
              </div>
              <div class="stat">
                <span class="stat-label">Disk Frei:</span>
                <span class="stat-value">
                  {{ systemStatus()!.system.disk.free_gb }} GB
                </span>
              </div>
            </div>
          </div>

          <!-- User Statistics -->
          <div class="status-section">
            <h3>üë• Benutzer</h3>
            <div class="stats-grid">
              <div class="stat">
                <span class="stat-label">Registrierte Benutzer:</span>
                <span class="stat-value highlight">{{ systemStatus()!.users.total }}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Online (letzte 5 Min):</span>
                <span class="stat-value online">{{ systemStatus()!.users.online_5min }}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Aktiv (letzte 15 Min):</span>
                <span class="stat-value">{{ systemStatus()!.users.active_15min }}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Neue Benutzer heute:</span>
                <span class="stat-value">{{ systemStatus()!.users.new_today }}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Neue Benutzer (7 Tage):</span>
                <span class="stat-value">{{ systemStatus()!.users.new_week }}</span>
              </div>
            </div>

            @if (systemStatus()!.users.roles) {
              <div class="roles-grid">
                <h4>Rollen</h4>
                <div class="stats-grid">
                  @for (role of objectKeys(systemStatus()!.users.roles); track role) {
                    <div class="stat">
                      <span class="stat-label">{{ getRoleLabel(role) }}:</span>
                      <span class="stat-value">{{ systemStatus()!.users.roles[role] }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Social Statistics -->
          <div class="status-section">
            <h3>ü§ù Soziale Aktivit√§t</h3>
            <div class="stats-grid">
              <div class="stat">
                <span class="stat-label">Freundschaften:</span>
                <span class="stat-value">{{ systemStatus()!.social.friendships }}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Offene Freundschaftsanfragen:</span>
                <span class="stat-value">{{ systemStatus()!.social.pending_friend_requests }}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Posts (gesch√§tzt):</span>
                <span class="stat-value">{{ systemStatus()!.social.posts_estimate }}</span>
              </div>
            </div>
          </div>

          <!-- Moderation Statistics -->
          <div class="status-section">
            <h3>üõ°Ô∏è Moderation</h3>
            <div class="stats-grid">
              <div class="stat">
                <span class="stat-label">Offene Reports:</span>
                <span class="stat-value" [class.warning]="systemStatus()!.moderation.open_reports > 10">
                  {{ systemStatus()!.moderation.open_reports }}
                </span>
              </div>
              <div class="stat">
                <span class="stat-label">Gesamt Reports:</span>
                <span class="stat-value">{{ systemStatus()!.moderation.total_reports }}</span>
              </div>
            </div>
          </div>

          <!-- DeepSeek API Balance -->
          <div class="status-section">
            <h3>ü§ñ DeepSeek API</h3>
            @if (deepseekBalance()) {
              <div class="stats-grid">
                <div class="stat">
                  <span class="stat-label">{{ i18n.t('admin.deepseekModel') }}:</span>
                  <span class="stat-value">{{ deepseekBalance()!.model }}</span>
                </div>
                <div class="stat">
                  <span class="stat-label">{{ i18n.t('admin.deepseekTotalBalance') }}:</span>
                  <span class="stat-value"
                    [class.warning]="deepseekBalance()!.total_balance < 5"
                    [class.critical]="deepseekBalance()!.total_balance < 1">
                    {{ deepseekBalance()!.total_balance.toFixed(2) }} {{ deepseekBalance()!.currency }}
                  </span>
                </div>
                <div class="stat">
                  <span class="stat-label">{{ i18n.t('admin.deepseekGranted') }}:</span>
                  <span class="stat-value">{{ deepseekBalance()!.granted_balance.toFixed(2) }} {{ deepseekBalance()!.currency }}</span>
                </div>
                <div class="stat">
                  <span class="stat-label">{{ i18n.t('admin.deepseekToppedUp') }}:</span>
                  <span class="stat-value">{{ deepseekBalance()!.topped_up_balance.toFixed(2) }} {{ deepseekBalance()!.currency }}</span>
                </div>
                <div class="stat">
                  <span class="stat-label">Status:</span>
                  <span class="stat-value" [class.online]="deepseekBalance()!.is_available" [class.warning]="!deepseekBalance()!.is_available">
                    {{ deepseekBalance()!.is_available ? i18n.t('admin.deepseekAvailable') : i18n.t('admin.deepseekUnavailable') }}
                  </span>
                </div>
              </div>
              @if (deepseekBalance()!.total_balance < 1) {
                <div class="deepseek-warning">
                  ‚ö†Ô∏è {{ i18n.t('admin.deepseekLowBalance') }}
                </div>
              }
            } @else if (deepseekError()) {
              <div class="deepseek-error">
                ‚ùå {{ deepseekError() }}
              </div>
            } @else {
              <p>‚è≥ {{ i18n.t('admin.deepseekLoading') }}</p>
            }
          </div>
        </div>
      } @else {
        <div class="loading-state">
          <p>‚è≥ Lade System-Status...</p>
        </div>
      }
    </div>
  }

  <!-- Settings Tab -->
  @if (activeTab() === 'settings') {
    <div class="tab-content">
      <h2>‚öôÔ∏è Site-Einstellungen</h2>
      <p class="description">
        Hier kannst du grundlegende Einstellungen fuer die Plattform konfigurieren.
      </p>

      <div class="form-card">
        <div class="form-group">
          <label for="site-url">Site-URL</label>
          <p class="field-description">
            Die oeffentliche URL deiner SafeSpace-Instanz. Wird in E-Mail-Benachrichtigungen
            und Action-Buttons verwendet.
          </p>
          <input
            id="site-url"
            type="url"
            [(ngModel)]="siteSettingsForm.site_url"
            placeholder="https://deine-domain.de"
            />
        </div>

        <div class="button-group">
          <button
            class="btn btn-primary"
            (click)="saveSiteSettings()"
            [disabled]="loading()">
            {{ loading() ? '‚è≥ Speichern...' : 'üíæ URL speichern' }}
          </button>
        </div>
      </div>

      <div class="form-card">
        <div class="form-group">
          <label for="site-title">Seitentitel</label>
          <p class="field-description">
            Dieser Titel wird oben links in der Navigation und als Browser-Tab-Titel angezeigt.
          </p>
          <input
            id="site-title"
            type="text"
            [(ngModel)]="siteTitleForm"
            placeholder="z.B. SafeSpace"
            maxlength="50" />
        </div>

        <div class="button-group">
          <button
            class="btn btn-primary"
            (click)="saveSiteTitle()"
            [disabled]="loading()">
            {{ loading() ? '‚è≥ Speichern...' : 'üíæ Titel speichern' }}
          </button>
        </div>
      </div>

      <!-- Email Settings & Test -->
      <div class="form-card">
        <h3>üìß {{ i18n.t('admin.emailSettings') }}</h3>
        <p class="description">{{ i18n.t('admin.emailSettingsDesc') }}</p>

        @if (emailSettings()) {
          <div class="email-settings-grid">
            <div class="stat">
              <span class="stat-label">Status:</span>
              <span class="stat-value" [class.online]="emailSettings().email_enabled" [class.warning]="!emailSettings().email_enabled">
                {{ emailSettings().email_enabled ? i18n.t('admin.emailEnabled') : i18n.t('admin.emailDisabled') }}
              </span>
            </div>
            <div class="stat">
              <span class="stat-label">SMTP Host:</span>
              <span class="stat-value">{{ emailSettings().smtp_host }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">SMTP Port:</span>
              <span class="stat-value">{{ emailSettings().smtp_port }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">{{ i18n.t('admin.emailUser') }}:</span>
              <span class="stat-value">{{ emailSettings().smtp_user || '‚Äî' }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">{{ i18n.t('admin.emailFrom') }}:</span>
              <span class="stat-value">{{ emailSettings().smtp_from_email }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">{{ i18n.t('admin.emailSender') }}:</span>
              <span class="stat-value">{{ emailSettings().smtp_from_name }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">TLS:</span>
              <span class="stat-value" [class.online]="emailSettings().smtp_use_tls">
                {{ emailSettings().smtp_use_tls ? 'Ja' : 'Nein' }}
              </span>
            </div>
          </div>

          <div class="test-email-section">
            <label for="test-email">{{ i18n.t('admin.testEmailLabel') }}</label>
            <div class="test-email-row">
              <input
                id="test-email"
                type="email"
                [(ngModel)]="testEmailAddress"
                [placeholder]="i18n.t('admin.testEmailPlaceholder')"
                [disabled]="testEmailLoading()" />
              <button
                class="btn btn-primary"
                (click)="sendTestEmail()"
                [disabled]="testEmailLoading() || !emailSettings().email_enabled">
                {{ testEmailLoading() ? '‚è≥ ...' : 'üì§ ' + i18n.t('admin.testEmailSend') }}
              </button>
            </div>
            @if (!emailSettings().email_enabled) {
              <p class="field-description warning-text">{{ i18n.t('admin.emailDisabledHint') }}</p>
            }
          </div>
        } @else {
          <p>‚è≥ {{ i18n.t('admin.loading') }}...</p>
        }
      </div>
    </div>
  }

  <!-- Email Templates Tab -->
  @if (activeTab() === 'email-templates') {
    <div class="tab-content">
      <h2>üìß E-Mail-Templates</h2>
      <p class="description">
        Hier kannst du die E-Mail-Benachrichtigungen bearbeiten. Verwende Platzhalter wie
        <code ngNonBindable>&#123;&#123;username&#125;&#125;</code>, <code ngNonBindable>&#123;&#123;actor&#125;&#125;</code> usw.
        und √ºbersetze Templates per Knopfdruck in alle Sprachen.
      </p>

      <div class="form-card">
        <!-- Typ und Sprache Auswahl -->
        <div class="template-selectors">
          <div class="form-group">
            <label for="template-type">Benachrichtigungstyp</label>
            <select id="template-type" [(ngModel)]="selectedNotificationType" (change)="onTemplateTypeChange()">
              @for (type of notificationTypes(); track type) {
                <option [value]="type">{{ notificationTypeLabels[type] || type }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label for="template-lang">Sprache</label>
            <select id="template-lang" [(ngModel)]="selectedTemplateLang" (change)="onTemplateLangChange()">
              @for (lang of availableLanguages; track lang.code) {
                <option [value]="lang.code">{{ lang.flag }} {{ lang.name }}</option>
              }
            </select>
          </div>
        </div>

        <!-- Betreff -->
        <div class="form-group">
          <label for="template-subject">Betreff</label>
          <input
            id="template-subject"
            type="text"
            [(ngModel)]="templateSubject"
            [placeholder]="'z.B. {{actor}} hat deinen Post geliked!'">
        </div>

        <!-- WYSIWYG Toolbar -->
        <div class="form-group">
          <label>Inhalt</label>
          <div class="editor-toolbar">
            <button type="button" class="toolbar-btn" (click)="execCommand('bold')" title="Fett"><b>B</b></button>
            <button type="button" class="toolbar-btn" (click)="execCommand('italic')" title="Kursiv"><i>I</i></button>
            <button type="button" class="toolbar-btn" (click)="execCommand('underline')" title="Unterstrichen"><u>U</u></button>
            <span class="toolbar-separator"></span>
            <button type="button" class="toolbar-btn" (click)="execCommand('insertUnorderedList')" title="Liste">&#8226;</button>
            <button type="button" class="toolbar-btn" (click)="execCommand('justifyLeft')" title="Links">&#8676;</button>
            <button type="button" class="toolbar-btn" (click)="execCommand('justifyCenter')" title="Zentriert">&#8596;</button>
            <span class="toolbar-separator"></span>
            <button type="button" class="toolbar-btn" (click)="execCommand('removeFormat')" title="Formatierung entfernen">&#10005;</button>
          </div>

          <!-- Editor -->
          <div
            id="template-editor"
            class="wysiwyg-editor"
            contenteditable="true"
            (input)="onEditorInput($event)"
            [innerHTML]="templateBody">
          </div>
        </div>

        <!-- Platzhalter Buttons -->
        <div class="placeholder-section">
          <label>Platzhalter einf√ºgen:</label>
          <div class="placeholder-buttons">
            <button type="button" class="placeholder-btn" (click)="insertPlaceholder('{{username}}')"><span ngNonBindable>&#123;&#123;username&#125;&#125;</span></button>
            <button type="button" class="placeholder-btn" (click)="insertPlaceholder('{{actor}}')"><span ngNonBindable>&#123;&#123;actor&#125;&#125;</span></button>
            <button type="button" class="placeholder-btn" (click)="insertPlaceholder('{{post_content}}')"><span ngNonBindable>&#123;&#123;post_content&#125;&#125;</span></button>
            <button type="button" class="placeholder-btn" (click)="insertPlaceholder('{{comment_content}}')"><span ngNonBindable>&#123;&#123;comment_content&#125;&#125;</span></button>
            <button type="button" class="placeholder-btn" (click)="insertPlaceholder('{{action_button}}')"><span ngNonBindable>&#123;&#123;action_button&#125;&#125;</span></button>
            <button type="button" class="placeholder-btn" (click)="insertPlaceholder('{{birthday_age}}')"><span ngNonBindable>&#123;&#123;birthday_age&#125;&#125;</span></button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="button-group" style="margin-top: 20px;">
          <button
            class="btn btn-primary"
            (click)="saveEmailTemplate()"
            [disabled]="loading()">
            {{ loading() ? '‚è≥ Speichern...' : 'üíæ Template speichern' }}
          </button>
          <button
            class="btn btn-translate"
            (click)="translateTemplate()"
            [disabled]="translating()">
            {{ translating() ? '‚è≥ √úbersetze...' : 'üåê In alle Sprachen √ºbersetzen' }}
          </button>
        </div>
      </div>

      <!-- Template √úbersicht -->
      <div class="form-card" style="margin-top: 20px;">
        <h3>Vorhandene Templates</h3>
        <div class="template-overview">
          @for (type of notificationTypes(); track type) {
            <div class="template-overview-row">
              <span class="template-type-label">{{ notificationTypeLabels[type] || type }}</span>
              <div class="template-lang-badges">
                @for (lang of availableLanguages; track lang.code) {
                  <span
                    class="lang-badge"
                    [class.lang-badge-active]="getTemplateLanguages(type).includes(lang.code)"
                    [title]="lang.name">
                    {{ lang.flag }}
                  </span>
                }
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
